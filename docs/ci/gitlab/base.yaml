.ai-review-base:
  when: manual
  image: nikitafilonov/ai-review:latest
  stage: checks
  rules:
    - if: '$CI_MERGE_REQUEST_IID'
  script:
    - ai-review run
  variables:
    # LLM
    LLM__PROVIDER: "OPENAI"
    LLM__META__MODEL: "gpt-4o-mini"
    LLM__META__MAX_TOKENS: "1200"
    LLM__META__TEMPERATURE: "0.3"
    LLM__HTTP_CLIENT__API_URL: "https://api.openai.com/v1"
    LLM__HTTP_CLIENT__API_TOKEN: "$OPENAI_API_KEY"

    # VCS
    VCS__PROVIDER: "GITLAB"
    VCS__HTTP_CLIENT__API_URL: "$CI_SERVER_URL"
    VCS__HTTP_CLIENT__API_TOKEN: "$CI_JOB_TOKEN"
    VCS__PIPELINE__PROJECT_ID: "$CI_PROJECT_ID"
    VCS__PIPELINE__MERGE_REQUEST_ID: "$CI_MERGE_REQUEST_IID"

    # Prompts
    PROMPT__INLINE_PROMPT_FILE: "./prompts/default_inline.md"
    PROMPT__SUMMARY_PROMPT_FILE: "./prompts/default_summary.md"

    # Review
    REVIEW__MODE: "CHANGED_WITH_CONTEXT"
    REVIEW__CONTEXT_LINES: "10"
    REVIEW__REVIEW_CHANGE_MARKER: "# changed"
  allow_failure: true

.ai-review-inline:
  script:
    - ai-review run-inline
  extends: .ai-review-base

.ai-review-summary:
  script:
    - ai-review run-summary
  extends: .ai-review-base
